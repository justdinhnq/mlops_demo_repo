name: Deploy Model to Online Endpoint

on:
  push:
    branches:
      - main

jobs:
  Deploy:
    name: Deploy Model
    runs-on: ubuntu-latest
  
    environment:
      name: Production

    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Azure AZ ML extension
        run: az extension add -n ml -y

      - name: Azure login
        uses: azure/login@v2 
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Register the Model
        run: |
          MODEL_NAME="diabetes-model"
          MODEL_PATH="azureml:/subscriptions/3be8cb13-1fd0-400f-85d2-1d617f572813/resourceGroups/resGrp/providers/Microsoft.MachineLearningServices/workspaces/ws01/codes/cc765684-fac1-49e4-b17e-64d38c5e3ce2/versions/1"
          az ml model create --name $MODEL_NAME --type "mlflow_model" --path $MODEL_PATH

      - name: Deploy Model to Endpoint
        run: |
          # Register the latest model from the MLflow run
          MODEL_NAME="diabetes-model"
          ENDPOINT_NAME="diabetes-endpoint-$(date +%s)"

          # Create an online endpoint
          az ml online-endpoint create --name $ENDPOINT_NAME -f create-endpoint.yaml

          # Deploy the model to the endpoint
          az ml online-deployment create --name blue --endpoint $ENDPOINT_NAME --model $MODEL_NAME:1 --all-traffic

      - name: Get Endpoint Details
        run: |
          ENDPOINT_NAME="diabetes-endpoint-$(date +%s)"
          SCORING_URI=$(az ml online-endpoint show --name $ENDPOINT_NAME --query scoring_uri -o tsv)
          echo "Scoring URI: $SCORING_URI"


        
